# 高温水用热量预估系统 (Heat Estimation & Billing System)

## 项目简介
这是一个基于 Next.js 开发的高温水用热量预估与计费管理系统。该系统旨在帮助供热管理单位通过历史抄表数据和气象数据，智能测算用户的用热基准参数（基准热量、温度系数），并基于实时天气预报预测未来的用热量及账户余额消耗情况。

## 核心功能
*   **单位管理**：管理用热单位的基本信息、计费标准及地理位置。
*   **抄表记录**：录入历史抄表数据（日期、读数），系统自动计算区间日均气温和日均热量。
*   **智能参数计算**：
    *   利用历史抄表数据和同期实际气温，通过线性回归分析计算出该单位的专属热力学参数：
        *   **基准热量 (Base Heat)**：在基准温度（15℃）下的基础日用热量。
        *   **温度系数 (Temp Coeff)**：气温每下降1℃增加的额外日用热量。
*   **用热预测与预警**：
    *   集成 Open-Meteo 天气预报 API，获取未来14天及更长期的气温预测。
    *   结合单位专属参数，模拟未来每日的预计用热量和费用。
    *   **余额预警**：直观展示账户余额预计耗尽日期，并在余额不足30天时发出红色预警。
    *   **数据导出**：支持将预测结果导出为 **Excel 报表**（包含概览、未来预测明细、历史模拟数据）或 **PNG 图片**（包含完整分析图表），方便归档与汇报。
*   **可视化分析**：提供直观的图表（Recharts），对比历史实际用热与模型拟合曲线，展示未来余额消耗趋势。

## 技术栈
*   **框架**：[Next.js 16](https://nextjs.org/) (App Router)
*   **语言**：TypeScript
*   **数据库**：SQLite (通过 Prisma ORM 管理)
*   **UI 组件库**：Ant Design (v5) + Tailwind CSS
*   **图表库**：Recharts
*   **导出工具**：xlsx (Excel导出), html-to-image (图片导出)
*   **数学库**：simple-statistics (回归分析), katex (公式渲染)
*   **工具库**：dayjs (时间处理)

## 算法与模型详解 (Algorithm & Model Detail)

本系统的核心竞争力在于其**基于真实物理规律与数据驱动**的混合预测模型。不同于简单的平均值估算，本系统通过“历史反演”与“未来模拟”两个阶段，实现高精度的热量预测。

### 1. 核心数学模型 (Core Mathematical Model)

系统建立在以下热力学基本假设之上：
**建筑物的日用热量 ($Q$) 与 室内外温差 ($\Delta T$) 成正比。**

$$ Q_{daily} = Q_{base} + K \cdot (T_{base} - T_{avg}) $$

其中：
*   **$Q_{daily}$** (GJ): 预测的单日耗热量。
*   **$T_{avg}$** (°C): 当日的室外平均气温（来自天气接口）。
*   **$T_{base}$** (°C): **基准温度**。设定为 **15°C**。即当室外气温达到 15°C 时，视为不需要供暖的临界点。
*   **$Q_{base}$** (GJ): **基准热量**。即在基准温度（15°C）下，维持建筑物基本运行（如管网热损耗、生活热水等）所需的最低基础热量。
*   **$K$** (GJ/°C): **温度系数**。代表建筑物的保温性能与采暖效率。即室外气温每下降 1°C，每天需要额外消耗的热量。

---

### 2. 智能参数计算流程 (Parameter Calculation Process)

如何得到每个单位专属的 $Q_{base}$ 和 $K$？系统利用历史抄表数据进行线性回归分析。

#### 步骤 2.1：数据预处理
*   **输入**：一系列抄表记录 $\{R_1, R_2, ..., R_n\}$。
*   **处理**：对于每两个相邻的抄表记录 $R_{i}$ 和 $R_{i+1}$，计算该区间的：
    *   **区间日均热量 ($Y_i$)**：$\frac{R_{i+1}.\text{reading} - R_{i}.\text{reading}}{\text{days}}$
    *   **区间日均气温 ($X_i$)**：通过 Open-Meteo 接口获取该时间段内每天的历史气温，并计算算术平均值。相比直接使用月平均气温，这种方法能精准捕捉该特定抄表周期的天气特征。

#### 步骤 2.2：线性回归 (Linear Regression)
*   构建数据集 $\{(X_1, Y_1), (X_2, Y_2), ...\}$。
*   使用最小二乘法 (Least Squares Method) 拟合直线方程 $y = mx + b$。
*   **映射关系**：
    *   斜率 $m$ 对应 $-K$（气温越低热量越高，故斜率为负）。
    *   截距 $b$ 对应 $Q_{base} + K \cdot T_{base}$。
*   **解算参数**：
    *   $K = -m$
    *   $Q_{base} = b - K \cdot 15$

---

### 3. 历史数据动态模拟 (Dynamic Historical Simulation)

为了在图表中展示“实际用热”曲线，系统需要将**区间总热量**还原为**每日热量**。
*   **传统方法**：将区间总热量平均分配到每一天。这会导致曲线呈阶梯状，无法反映气温波动对用热的影响。
*   **本系统优化算法**：**加权分配法**。
    1.  利用步骤2计算出的 $K$ 和 $Q_{base}$，结合每一天的实际历史气温，计算出当天的**理论热需求 ($D_j$)**。
    2.  计算该区间的**总理论需求 ($\sum D$)**。
    3.  计算每一天的**分配权重 ($W_j = D_j / \sum D$)**。
    4.  **每日实际模拟热量 = 区间实际总热量 $\times W_j$**。
*   **优势**：即使抄表间隔长达一个月，系统也能还原出“天冷多用、天热少用”的真实波动曲线，极大地提高了数据的可解释性与可视化的真实感。

---

### 4. 未来预测与余额预警 (Prediction & Alert)

#### 步骤 4.1：获取未来气象数据
*   调用 Open-Meteo API 获取未来 14 天的逐日气温预报。
*   对于 14 天之后的日期，采用**历史气候模拟算法**：基于所在城市的历史同期气温模型（如1月均温-5°C，3月均温5°C），叠加随机扰动因子，生成未来 120 天的模拟气温数据。

#### 步骤 4.2：逐日递推
*   **初始状态**：当前账户余额。
*   **循环计算** (Day 1 to Day 120)：
    1.  读取当日预测气温 $T_{pred}$。
    2.  代入模型计算当日预计耗热：$Q_{pred} = Q_{base} + K \cdot (15 - T_{pred})$。
    3.  计算当日预计费用：$Cost = Q_{pred} \times \text{Unit Price}$。
    4.  更新余额：$Balance_{new} = Balance_{old} - Cost$。
    5.  **判断**：如果 $Balance_{new} \le 0$，则标记当日为**预计欠费日期**，停止计算或继续计算欠费金额。

#### 步骤 4.3：预警触发
*   根据预计欠费日期，计算剩余可用天数。
*   如果 **剩余天数 < 30天**，前端界面触发红色警报，并建议用户及时充值。

---

## 性能优化策略

## 性能优化策略

### 1. 天气数据缓存 (Cache-First)
*   为了减少对外部 API (Open-Meteo) 的依赖并提高响应速度，系统实现了本地数据库缓存机制。
*   **DailyWeather 表**：存储所有已获取的历史和未来气温数据。
*   **逻辑**：在请求气温时，优先查询本地数据库。只有当数据库中缺失对应日期的记录时，才发起外部 API 请求，并自动将新数据存入库中。

### 2. 预测结果持久化
*   **UnitPrediction 表**：计算成功后，将完整的预测结果（包括剩余天数、预估日期、月度统计等）序列化存储到数据库。
*   **逻辑**：用户再次访问预测页面时，直接从数据库加载上次计算的结果，无需每次都进行复杂的回归分析和数据模拟，极大提升页面加载速度。仅在用户点击“重新计算”时才触发重新运算。

## 天气 API 集成
本项目使用 [Open-Meteo API](https://open-meteo.com/) 获取高精度的历史天气和未来预报数据。
*   **无需 API Key**：完全免费且开源。
*   **数据源**：整合了 DWD, NOAA, ECMWF, MET Norway 等多家气象机构数据。
*   **功能**：
    *   根据单位经纬度（默认淄博坐标：36.81, 118.05）获取当地天气。
    *   获取过去时段的实际气温用于参数训练。
    *   获取未来14天的精细预报用于短期预测。

## 部署与使用指南 (Deployment Guide)

本系统采用 SQLite 数据库，数据文件 (`prisma/dev.db`) 默认被 Git 忽略，因此在异地部署或重新下载代码后，需要执行数据库初始化操作。

### 1. 环境准备
*   **Node.js**: 需安装 Node.js 18.0 或更高版本。
*   **Git**: 用于拉取代码 (可选)。

### 2. 获取代码
如果您是异地部署，可以通过 GitHub 拉取代码：
```bash
git clone <repository-url>
cd gwsyugu
```
*注意：由于隐私保护，GitHub 仓库中不包含数据库文件和日志文件。*

### 3. 安装依赖与本地配置 (Local Development Setup)
1.  **安装依赖**：
    在项目根目录下执行：
    ```bash
    npm install
    ```

2.  **配置环境变量**：
    新建一个 `.env` 文件，并添加以下内容（指定本地数据库路径）：
    ```bash
    DATABASE_URL="file:./prisma/dev.db"
    ```

3.  **数据库初始化 (关键步骤)**
    由于下载的代码中没有 `dev.db` 文件，首次运行时必须重新生成数据库结构：
    ```bash
    npx prisma migrate dev
    ```
    *   该命令会根据 `prisma/schema.prisma` 定义，在 `prisma/` 目录下重新生成 `dev.db` 文件。

### 4. 启动系统

#### 方式 A：开发模式 (Development)
适用于调试和开发：
```bash
npm run dev
```
访问：`http://localhost:3000`

#### 方式 B：生产模式 (Production)
适用于正式使用，性能更优：
1.  **构建应用**：
    ```bash
    npm run build
    ```
2.  **启动服务**：
    ```bash
    npm start
    ```
    *建议使用 PM2 等工具进行进程守护，例如：`pm2 start npm --name "heat-system" -- start`*

### 6. 低内存 VPS 部署指南 (Standalone 模式)
对于内存较小（如 1G）的 VPS，直接在服务器上编译容易内存溢出。推荐在本地编译后上传运行。

#### 1. 本地打包
在您的开发机（Mac/Windows）上运行项目根目录下的打包脚本：
```bash
# 给予执行权限 (仅需一次)
chmod +x build-for-vps.sh

# 执行打包
./build-for-vps.sh
```
该脚本会自动：
*   生成适配 Linux 的数据库引擎
*   进行独立模式编译 (Standalone)
*   组装所有必要文件并压缩为 `deploy.tar.gz`

#### 2. 上传与运行
将生成的 `deploy.tar.gz` 上传到 VPS，然后执行：
```bash
# 1. 解压
tar -xzf deploy.tar.gz

# 2. 运行 (自动处理数据库初始化)
./start.sh
```
*   该模式无需在 VPS 上运行 `npm install`。
*   默认端口为 3000，可在 `start.sh` 中修改。

### 7. 数据迁移与备份
*   **数据迁移**：如果您需要保留原有的数据，请手动复制原机器上的 `prisma/dev.db` 文件到新部署机器的 `prisma/` 目录下，覆盖新生成的空数据库。
*   **数据导入**：如果是全新部署，您可以使用系统自带的“Excel 粘贴导入”功能，快速录入历史抄表数据。

### 8. 安全与维护注意事项 (重要)
*   **关于 npm audit**: 运行 `npm install` 后可能会看到关于 `lodash` 的漏洞警告。**请勿运行 `npm audit fix --force`**。这会导致 Prisma 降级到旧版本 (6.x)，从而破坏当前项目对 Prisma 7 的配置兼容性，导致无法启动。请保持 Prisma 7.3.0 版本不变。
*   **数据备份**: 定期备份 `prisma/dev.db` 文件即可保障数据安全。

## 目录结构
*   `/app`: Next.js 页面路由及 API 路由
*   `/actions`: Server Actions (业务逻辑核心)
*   `/components`: React UI 组件
*   `/lib`: 工具函数及 Prisma 客户端实例
*   `/prisma`: 数据库模型定义 (schema.prisma) 及迁移文件
