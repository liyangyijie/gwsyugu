# 供热计量收费管理系统 - 用户使用手册

本文档为**供热计量收费管理系统 (GWSYUGU)** 的详细操作指南，涵盖单位管理、抄表记录、财务流水、导入导出等核心功能。

## 1. 快速入门

### 1.1 系统登录
- 访问系统网址。
- 输入管理员分发的访问密码即可进入系统。

### 1.2 主界面概览 (Dashboard)
登录后即进入**仪表盘 (Dashboard)**，主要展示：
- **总单位数**: 当前系统中管理的供热单位总数。
- **总余额**: 所有单位账户余额之和。
- **欠费预警**: 余额不足或已欠费的单位列表，按欠费金额排序。
- **用量预警**: 根据当前余额和历史用量预测，剩余可用天数不足的单位（默认阈值：30天）。
  - **注意**: 共用账户（子单位）的预警会基于父单位的总余额和全组总用量进行计算。

> **性能提示**: 仪表盘上的“一键全部单位预测计算”按钮已升级为**并发计算模式**，即使管理上千个单位也能在数十秒内完成全量更新，请放心使用。

---

## 2. 单位管理 (Unit Management)

### 2.1 查看单位列表
在左侧菜单点击“单位管理”，可查看所有单位。
- **搜索**: 支持按单位名称、编号搜索。
- **状态显示**:
  - **正常**: 账户余额 > 0。
  - **欠费**: 账户余额 < 0（红色高亮）。
- **共用账户标识**: 子单位会在名称旁显示“共用账户: [父单位名称]”。

### 2.2 新建单位
点击右上角“新建单位”按钮：
- **名称**: 必填，单位唯一标识（如“1号楼101”）。
- **编号**: 选填，内部编号。
- **单价**: 默认为 88.0 元/GJ（可修改）。
- **初始余额**: 新建时的预充值金额。
- **初始余额日期**: 可选。若填写，则该笔初始余额的生效日期为指定日期；若不填，默认为创建当日。此功能用于补录历史期初数据。

### 2.3 编辑与共用账户绑定
点击单位列表中的任意单位进入**详情页**，点击右上角“编辑”：
- **修改基本信息**: 如单价、面积等。
- **绑定父单位 (Shared Account)**:
  - 在“所属父单位”下拉框中选择一个已存在的单位作为父账户。
  - **自动资金合并**: 绑定时，若子单位当前有余额，系统会自动将余额转入父单位账户，子单位余额归零。
  - **解绑**: 将“所属父单位”设为空即可解绑（注意：解绑不会自动退还已合并的资金，需手动调整）。

### 2.4 删除单位
- 在详情页点击“删除”按钮。
- **注意**: 删除单位会同时删除其所有的抄表记录、财务流水和预测数据。此操作不可恢复，请谨慎！

---

## 3. 抄表管理 (Meter Readings)

### 3.1 手动录入抄表
1. 进入单位详情页。
2. 点击“新增抄表”按钮。
3. 填写**当前读数**和**抄表日期**（温度会自动获取或手动填写）。
4. **费用计算**:
   - 系统自动计算：`(当前读数 - 上次读数) × 单价`。
   - **共用账户扣费**: 如果该单位是子单位，费用将自动从**父单位余额**中扣除，并生成一条属于父单位的扣费记录。

### 3.2 批量抄表录入 (Batch Entry)
此功能允许在同一页面为所有单位快速录入读数，适合每月集中抄表时使用。
1. 点击“单位管理”页面右上角的“批量抄表”按钮（或直接访问 `/readings/batch`）。
2. **选择抄表日期**: 默认为今天。系统会自动获取该日期的气温数据。
3. **录入读数**: 在列表中依次输入各个单位的当前读数。
   - **校验**: 系统会自动校验，输入的读数不能小于上次读数。
   - **自动跳过**: 未输入的单位会被自动跳过。
4. 点击“提交录入”，系统将批量处理并生成对应的扣费记录。

### 3.3 批量导入 (Excel Import)
适用于大批量录入数据。
1. 点击左侧菜单“系统设置” -> “数据导入/导出”。
2. **下载模板**: 点击“下载导入模板”获取标准 Excel 文件。
3. **填写数据**:
   - **单位信息 Sheet**: 填写名称、单价、父单位名称（若有）。**新增**: 支持填写“初始余额日期”，用于精确设置期初余额的生效时间。
   - **抄表记录 Sheet**: 填写单位名称、日期、读数。
     - **0值处理**: 系统严格区分“0”和“空值”。录入 `0` 表示有效读数为0；留空则表示未抄表（跳过不处理）。
4. **上传导入**:
   - 选择文件上传。
   - 系统会自动校验数据格式。
   - **共用账户处理**: 导入时会自动识别父子关系，确保费用扣除正确（扣除父单位余额）。

### 3.4 修改与删除记录
- **修改**: 在单位详情页的“抄表记录”列表中，点击“编辑”图标。修改读数后，系统会自动重新计算费用并调整账户余额（多退少补）。
- **删除**: 点击“删除”图标。系统会自动退还该笔记录扣除的费用到账户余额。

---

## 4. 财务管理 (Financial)

### 4.1 充值 (Recharge)
1. 进入单位详情页。
2. 点击“充值”按钮。
3. 输入金额和备注。
4. **共用账户**: 只能给**父单位**充值。如果尝试给子单位充值，系统会提示并跳转至父单位页面。

### 4.2 余额调整 (Adjustment)
用于修正数据或特殊扣款。
1. 在单位详情页点击“余额调整”。
2. 选择“增加”或“减少”余额。
3. 填写金额和原因。

### 4.3 财务报表
点击左侧菜单“财务管理”：
- 查看所有流水记录（充值、扣费、调整）。
- 支持按时间、类型筛选。
- **导出结算报表**: 点击“导出结算报表”下载 Excel 文件。
  - 该报表同样采用“回放余额”算法，基于抄表日期（Effective Date）计算指定时间段的期初、期末余额和期间用量。

### 4.4 余额快照查询 (Monthly Snapshot)
用于查询历史上某一特定日期的账户余额状态（如每月15日）。
1. 点击“财务管理” -> “财务流水明细”。
2. 点击右上角的“历史余额快照”按钮。
3. **选择日期**: 选择您想查看的日期（如 2023-11-15）。
4. **查看结果**: 列表将显示在该日期结束时各单位的账户余额。
   - **核心逻辑**: 系统采用“回放余额”算法。即使您的抄表数据是在 1月20日 录入的（抄表日期为 1月15日），在查询 1月15日 的快照时，系统也会包含该笔扣费，确保还原真实的月度财务状况。
   - **状态联动**: 共用账户的子单位会根据父单位在当时的余额状态，自动显示为“正常”或“欠费”。
   - **性能优化**: 列表已启用虚拟滚动技术 (Virtual Scrolling)，支持流畅查看数千条记录。

---

## 5. 数据导入与导出 (Import/Export)

### 5.1 数据备份与迁移
在“系统设置”页面：
- **导出单位数据**: 包含所有单位的基础信息、父子关系、当前余额。
- **导出抄表记录**: 包含所有历史抄表读数。
  - **格式说明**: 导出格式已优化为**透视表 (Pivot Table)** 形式。
    - 第一列为“单位名称”。
    - 后续列为具体的抄表日期（如 2025-11-25）。
    - 单元格内为对应的读数。
  - 此格式不仅便于直观对比，且系统**支持直接导入**该格式的 Excel 文件，无需转换。
- **导出财务记录**: 包含所有流水明细。

### 5.2 常见问题 (FAQ)
- **Q: 导入时提示“单位不存在”？**
  A: 请确保 Excel 中的“单位名称”与系统中已有的完全一致，或者在“单位信息”Sheet 中先添加该单位。
- **Q: 子单位为什么显示余额为 0？**
  A: 子单位共享父单位的账户，自身不持有余额。费用直接从父单位扣除。
- **Q: 如何查看共用账户的总余额？**
  A: 在父单位的详情页查看，或者在子单位详情页查看“共用余额 (父单位名)”。

---

## 6. 系统维护

### 6.1 密码修改
- 目前密码通过环境变量配置（管理员在后台修改）。

### 6.2 数据安全
- 建议定期导出数据进行备份。
- 敏感操作（如批量删除、余额调整）请谨慎进行。
